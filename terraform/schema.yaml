# Copyright (c) 2025 Oracle Corporation and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl

title: "OKE GPU/RDMA Quickstart"
description: Oracle Cloud Infrastructure for running AI/ML workloads on OKE
stackDescription: Oracle Cloud Infrastructure for running AI/ML workloads on OKE
schemaVersion: 1.1.0
version: "20230304"
locale: "en"

variableGroups:
  - title: "Hidden"
    visible: false
    variables:
      # Provider auth
      - api_fingerprint
      - oci_auth
      - oci_profile
      # ORM Variables
      - current_user_ocid
      - tenancy_ocid
      - region
      # Bastion variables
      - bastion_image_id
      - bastion_image_os
      - bastion_image_os_version
      - bastion_image_type
      - bastion_user
      # Operator variables
      - operator_image_id
      - operator_image_os
      - operator_image_os_version
      - operator_image_type
      - operator_user
      # Storage
      - lustre_cluster_placement_group_id
      - lustre_file_system_name
      # Conditional visibility by type
      - worker_cpu_image_id
      - worker_gpu_image_id
      - worker_rdma_image_id
      - oke_ons_webhook_chart_version
      # Monitoring
      - wildcard_dns_domain
      - monitoring_advanced_options

  - title: "Identity"
    variables:
      - create_policies

  - title: Network
    variables:
      - create_vcn
      - vcn_compartment_ocid
      - vcn_id
      - vcn_name
      - vcn_cidrs
      - create_public_subnets
      - networking_advanced_options
      - custom_subnet_ids
      - bastion_sn_cidr
      - operator_sn_cidr
      - int_lb_sn_cidr
      - pub_lb_sn_cidr
      - cp_sn_cidr
      - workers_sn_cidr
      - fss_sn_cidr
      - lustre_sn_cidr
      - pods_sn_cidr
      - bastion_sn_id
      - operator_sn_id
      - int_lb_sn_id
      - pub_lb_sn_id
      - cp_sn_id
      - workers_sn_id
      - pods_sn_id
      - fss_sn_id
      - lustre_sn_id
      - private_subnet_route_table
      - public_subnet_route_table

  - title: Bastion & Operator
    variables:
      - create_bastion
      - bastion_is_public
      - bastion_allowed_cidrs
      - bastion_shape_config
      - bastion_shape_name
      - bastion_shape_ocpus
      - bastion_shape_memory
      - create_operator
      - operator_shape_config
      - operator_shape_name
      - operator_shape_ocpus
      - operator_shape_memory
      - operator_shape_boot

  - title: OKE Cluster
    variables:
      - create_cluster
      - compartment_ocid
      - cluster_name
      - kubernetes_version
      - cni_type
      - control_plane_is_public
      - control_plane_allowed_cidrs
      - max_pods_per_node
      - disable_gpu_device_plugin
      - preferred_kubernetes_services
      - setup_credential_provider_for_ocir

  - title: "Workers: System"
    variables:
      - worker_ops_ad
      - worker_ops_pool_size
      - worker_ops_shape
      - worker_ops_ocpus
      - worker_ops_memory
      - worker_ops_boot_volume_size
      - worker_ops_image_type
      - worker_ops_image_use_uri
      - worker_ops_image_custom_uri
      - worker_ops_image_compartment
      - worker_ops_image_custom_id
      
  - title: "Workers: CPU"
    variables:
      - worker_cpu_enabled
      - worker_cpu_ad
      - worker_cpu_pool_size
      - worker_cpu_shape
      - worker_cpu_ocpus
      - worker_cpu_memory
      - worker_cpu_boot_volume_size
      - worker_cpu_image_type
      - worker_cpu_image_os
      - worker_cpu_image_os_version
      - worker_cpu_image_platform_id
      - worker_cpu_image_use_uri
      - worker_cpu_image_custom_uri
      - worker_cpu_image_compartment
      - worker_cpu_image_custom_id
      
  - title: "Workers: GPU"
    variables:
      - worker_gpu_enabled
      - worker_gpu_ad
      - worker_gpu_pool_size
      - worker_gpu_shape
      - worker_gpu_boot_volume_size
      - worker_gpu_image_type
      - worker_gpu_image_os
      - worker_gpu_image_os_version
      - worker_gpu_image_platform_id
      - worker_gpu_image_use_uri
      - worker_gpu_image_custom_uri
      - worker_gpu_image_compartment
      - worker_gpu_image_custom_id

  - title: "Workers: GPU + RDMA"
    variables:
      - worker_rdma_enabled
      - worker_rdma_ad
      - worker_rdma_pool_size
      - worker_rdma_shape
      - worker_rdma_boot_volume_size
      - worker_rdma_boot_volume_vpus_per_gb
      - worker_rdma_image_os
      - worker_rdma_image_os_version
      - worker_rdma_image_type
      - worker_rdma_image_platform_id
      - worker_rdma_image_use_uri
      - worker_rdma_image_custom_uri
      - worker_rdma_image_compartment
      - worker_rdma_image_custom_id
  
  - title: "SSH Access"
    variables:
    - ssh_public_key

  - title: "Storage"
    variables:
    - nvme_raid_enabled
    - nvme_raid_level
    - create_bv_high
    - create_fss
    - fss_ad
    - fss_mount_path
    - create_lustre
    - lustre_ad
    - lustre_size_in_tb
    - lustre_performance_tier
    - install_lustre_client
    - lustre_client_helm_chart_version
    - create_lustre_pv

  - title: "Monitoring & Observability"
    variables:
    - install_monitoring
    - monitoring_advanced_options
    - monitoring_namespace
    - install_node_problem_detector_kube_prometheus_stack
    - install_nvidia_dcgm_exporter
    - dcgm_exporter_chart_version
    - install_amd_device_metrics_exporter     
    - amd_device_metrics_exporter_chart_version 
    - node_problem_detector_chart_version
    - prometheus_stack_chart_version
    - nginx_chart_version
    - install_grafana
    - install_grafana_dashboards
    - use_lets_encrypt_prod_endpoint
    - setup_alerting

  - title: "Stack Configuration"
    variables:
      - deploy_to_oke_from_orm
      - avoid_waiting_for_delete_target

variables:
  # Injected by ORM
  current_user_ocid:
    title: User
    type: ocid
  tenancy_ocid:
    title: Tenancy
    type: oci:identity:compartment:id
    required: true
  compartment_ocid:
    title: Compartment
    description: The default compartment for created resources.
    type: oci:identity:compartment:id
    required: true
  region:
    required: true
    title: Region
    type: oci:identity:region:name
  
  # Provider auth variables
  oci_auth:
    default: null
  oci_profile:
    default: null

  # Identity
  create_policies:
    title: Create policies
    description: "Provision a Dynamic Group with policies for Cluster Autoscaler, Self-managed nodes. This option assumes your user has the necessary permissions to create a dynamic group and policies in the root compartment of your tenancy."
    type: boolean
    default: true

  # VCN
  create_vcn:
    title: Create VCN
    type: boolean
    default: true
  vcn_compartment_ocid:
    title: VCN Compartment
    type: oci:identity:compartment:id
    required: false
    default: ${compartment_ocid}
    dependsOn:
      compartmentId: ${compartment_ocid}
    visible: { not: [create_vcn] }
  vcn_id:
    title: Existing VCN
    type: oci:core:vcn:id
    required: true
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
    visible: { not: [create_vcn] }
  networking_advanced_options:  
    title: Subnets advanced settings
    type: boolean
    default: false
    required: false
  custom_subnet_ids:  
    title: Select existing subnets
    type: boolean
    default: true
    required: false
    visible: 
      and:
      - { not: [create_vcn] }
      - networking_advanced_options
  bastion_sn_id:
    title: Existing subnet to use for the bastion
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  operator_sn_id:
    title: Existing subnet to use for the operator
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  int_lb_sn_id:
    title: Existing subnet to use for the internal load balancers
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  pub_lb_sn_id:
    title: Existing subnet to use for the public load balancers
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  cp_sn_id:
    title: Existing subnet to use for the OKE control plane
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  workers_sn_id:
    title: Existing subnet to use for the worker nodes
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  pods_sn_id:
    title: Existing subnet to use for the pods
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  fss_sn_id:
    title: Existing subnet to use for the fss
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  lustre_sn_id:
    title: Existing subnet to use for the Lustre File System
    type: oci:core:subnet:id
    required: false
    dependsOn:
      compartmentId: ${vcn_compartment_ocid}
      vcnId: ${vcn_id}
    visible: 
      and:
      - { not: [create_vcn] }
      - custom_subnet_ids
      - networking_advanced_options
  bastion_sn_cidr:
    title: Subnet CIDR for the bastion subnet
    description: CIDR subnet to use for the bastion subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  operator_sn_cidr:
    title: Subnet CIDR for the operator subnet
    description: CIDR subnet to use for the operator subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  int_lb_sn_cidr:
    title: Subnet CIDR for the internal load balancer subnet
    description: CIDR subnet to use for the internal load balancer subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  pub_lb_sn_cidr:
    title: Subnet CIDR for the public load balancer subnet
    description: CIDR subnet to use for the public load balancer subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  cp_sn_cidr:
    title: Subnet CIDR for the OKE control plane subnet
    description: CIDR subnet to use for the OKE control plane subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  workers_sn_cidr:
    title: Subnet CIDR for the workers subnet
    description: CIDR subnet to use for the workers subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  pods_sn_cidr:
    title: Subnet CIDR for the pods subnet
    description: CIDR subnet to use for the pods subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  fss_sn_cidr:
    title: Subnet CIDR for the fss subnet
    description: CIDR subnet to use for the pods subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  lustre_sn_cidr:
    title: Subnet CIDR for the Lustre subnet
    description: CIDR subnet to use for the pods subnet. If not provided a dynamic subnet will be created if required.
    type: string
    pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:1[6-9])|(?:2[0-9])|(?:30)$"
    required: false
    visible:
      or:
      - and:
        - { not: [create_vcn] }
        - { not: [custom_subnet_ids] }
        - networking_advanced_options
      - and:
        - create_vcn
        - networking_advanced_options
  private_subnet_route_table:
    title: OCID of the route table to be used with the private subnets
    description: If not provided, a new NAT GW and Service GW will be created.
    type: string
    required: false
    visible:
      and:
      - { not: [create_vcn] }
      - { not: [custom_subnet_ids] }
      - networking_advanced_options
  public_subnet_route_table:
    title: OCID of the route table to be used with the public subnets
    description: If not provided, a new Internet GW will be created.
    type: string
    required: false
    visible:
      and:
      - { not: [create_vcn] }
      - { not: [custom_subnet_ids] }
      - networking_advanced_options
  vcn_name:
    title: Virtual Cloud Network (VCN) name
    description: Display name for the created VCN. Defaults to 'oke' suffixed with the generated Terraform 'state_id' value.
    type: string
    required: true
    visible: ${create_vcn}
  vcn_cidrs:
    title: VCN CIDR ranges
    description: Comma-separated list of CIDR blocks for the created VCN.
    type: string
    required: true
    visible: ${create_vcn}
  create_public_subnets:
    title: Create public subnets
    description: Whether to create public subnets to host Internet addresable resources
    type: boolean
    default: true
    visible: ${create_vcn}

  # Bastion
  create_bastion:
    title: Create bastion instance
    type: boolean
    description: Create a Compute instance for public SSH access to VCN.
    visible: true
  bastion_is_public:
    title: Create the bastion in a public subnet
    type: boolean
    visible: 
      and:
      - create_bastion
      - create_public_subnets
  bastion_allowed_cidrs:
    title: Bastion allowed CIDRs
    description: List of CIDR ranges for allowed SSH communication to bastion instance.
    required: false
    type: array
    items:
      type: string
      pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:[0-2]?[0-9])|(?:3[0-2])$"
    unique_items: true
    minItems: 0
    visible: ${create_bastion}
  bastion_shape_config:
    title: Configure the bastion shape
    type: boolean
    default: false
    required: false
    visible: ${create_bastion}
  bastion_shape_name:
    title: Bastion instance shape
    type: oci:core:instanceshape:name
    pattern: "^(VM|BM)\\.Standard.*$"
    required: true
    visible:
      and:
      - create_bastion
      - bastion_shape_config
    dependsOn:
      compartmentId: ${compartment_ocid}
  bastion_shape_ocpus:
    title: Bastion OCPUs
    type: number
    required: true
    default: 1
    visible:
      and:
      - create_bastion
      - bastion_shape_config
      - or:
          - eq: [bastion_shape_name, "VM.Standard3.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.A1.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.A2.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.E4.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.E5.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.E6.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.x86.Generic"]
          - eq: [bastion_shape_name, "VM.Standard.AMD.Generic"]
          - eq: [bastion_shape_name, "VM.Standard.Ampere.Generic"]
          - eq: [bastion_shape_name, "VM.Standard.Intel.Generic"]
  bastion_shape_memory:
    title: Bastion Memory (GB)
    type: number
    required: true
    default: 8
    visible:
      and:
      - create_bastion
      - bastion_shape_config
      - or:
          - eq: [bastion_shape_name, "VM.Standard3.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.A1.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.A2.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.E4.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.E5.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.E6.Flex"]
          - eq: [bastion_shape_name, "VM.Standard.x86.Generic"]
          - eq: [bastion_shape_name, "VM.Standard.AMD.Generic"]
          - eq: [bastion_shape_name, "VM.Standard.Ampere.Generic"]
          - eq: [bastion_shape_name, "VM.Standard.Intel.Generic"]

  # Operator
  create_operator:
    title: Create operator instance
    description: Provision an OCI Compute instance configured with access to interact with the OKE Kubernetes endpoint.
    type: boolean
    required: false
    visible: create_cluster
  operator_shape_config:
    title: Configure operator shape
    type: boolean
    default: false
    required: false
    visible: 
      and:
        - create_cluster
        - ${create_operator}
  operator_shape_name:
    title: Shape
    type: oci:core:instanceshape:name
    pattern: "^(VM|BM)\\.(?!GPU).*$"
    required: true
    visible: 
      and:
        - create_cluster
        - create_operator
        - operator_shape_config
    dependsOn:
      compartmentId: ${compartment_ocid}
  operator_shape_ocpus:
    title: OCPUs
    type: number
    required: true
    default: 1
    visible:
      and:
        - create_cluster
        - create_operator
        - operator_shape_config
        - or:
            - eq: [operator_shape_name, "VM.Standard3.Flex"]
            - eq: [operator_shape_name, "VM.Standard.A1.Flex"]
            - eq: [operator_shape_name, "VM.Standard.A2.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E4.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E5.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E6.Flex"]
            - eq: [operator_shape_name, "VM.Standard.x86.Generic"]
            - eq: [operator_shape_name, "VM.Standard.AMD.Generic"]
            - eq: [operator_shape_name, "VM.Standard.Ampere.Generic"]
            - eq: [operator_shape_name, "VM.Standard.Intel.Generic"]
  operator_shape_memory:
    title: Memory (GB)
    type: number
    required: true
    default: 8
    visible:
      and:
        - create_cluster
        - create_operator
        - operator_shape_config
        - or:
            - eq: [operator_shape_name, "VM.Standard3.Flex"]
            - eq: [operator_shape_name, "VM.Standard.A1.Flex"]
            - eq: [operator_shape_name, "VM.Standard.A2.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E4.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E5.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E6.Flex"]
            - eq: [operator_shape_name, "VM.Standard.x86.Generic"]
            - eq: [operator_shape_name, "VM.Standard.AMD.Generic"]
            - eq: [operator_shape_name, "VM.Standard.Ampere.Generic"]
            - eq: [operator_shape_name, "VM.Standard.Intel.Generic"]
  operator_shape_boot:
    title: Boot volume size (GB)
    type: number
    required: true
    visible:
      and:
        - create_cluster
        - create_operator
        - operator_shape_config
        - or:
            - eq: [operator_shape_name, "VM.Standard3.Flex"]
            - eq: [operator_shape_name, "VM.Standard.A1.Flex"]
            - eq: [operator_shape_name, "VM.Standard.A2.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E4.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E5.Flex"]
            - eq: [operator_shape_name, "VM.Standard.E6.Flex"]
            - eq: [operator_shape_name, "VM.Standard.x86.Generic"]
            - eq: [operator_shape_name, "VM.Standard.AMD.Generic"]
            - eq: [operator_shape_name, "VM.Standard.Ampere.Generic"]
            - eq: [operator_shape_name, "VM.Standard.Intel.Generic"]
 
  # Storage
  create_fss:
    title: Create a Storage Class backed by File Storage Service (FSS) file system
    description: Provision a shared File Storage Service (FSS) file system and create a Storage Class.
    type: boolean
    default: false
    required: create_cluster
    visible: create_cluster
  fss_ad:
    title: FSS availability domain
    type: oci:identity:availabilitydomain:name
    required: create_cluster
    default: worker_ops_ad
    visible: 
      and:
        - create_cluster
        - ${create_fss}
    dependsOn:
      compartmentId: ${compartment_ocid}
  fss_mount_path:
    title: FSS mount point
    type: string
    default: "/mnt/oci-fss"
    required: create_cluster
    visible: 
      and: 
        - create_cluster
        - ${create_fss}
  create_bv_high:
    title: Create a storage class backed by higher performance OCI block volumes
    description: "Create a storage class backed by higher performance OCI block volumes (VPU: 20)."
    type: boolean
    required: create_cluster
    default: false
    visible: create_cluster
  nvme_raid_enabled:
    type: boolean
    title: Create a RAID array using local NVMe drives 
    description: If the instance has local NVMe drives, create a RAID 10 or 0 array with bind mounts for container runtime (/var/lib/containers), Kubelet ephemeral storage (/var/lib/kubelet), and logs (/var/log/pods).
    default: true
    visible: create_cluster
  nvme_raid_level:
    title: RAID Level
    type: enum
    default: "10"
    enum: ["0", "10"]
    required: create_cluster
    visible: 
      and:
        - create_cluster
        - nvme_raid_enabled
  create_lustre:
    title: Create Lustre FS
    description: Provision a shared Lustre file system and a PV backed by the Lustre file system.
    type: boolean
    default: false
    required: create_cluster
    visible: create_cluster
  lustre_ad:
    title: Availability domain
    type: oci:identity:availabilitydomain:name
    required: ${create_lustre}
    default: ${worker_ops_ad}
    visible: 
      and: 
        - create_cluster
        - ${create_lustre}
    dependsOn:
      compartmentId: ${compartment_ocid}
  lustre_size_in_tb:
    title: Lustre file system size in TB
    description: Starting from minimum 31.2 TB, increment step must be 10.4 TB when the capacity is less than or equal to 124.8 TB. Increment step must be 41.6 TB when the capacity is greater than 124.8 TB.
    type: number
    minimum: 31.2
    default: 31.2
    multipleOf: 10.4
    required: ${create_lustre}
    visible: 
      and: 
        - create_cluster
        - ${create_lustre}
  lustre_performance_tier:
    title: Lustre Performance Tier
    description: Specify the performance tier for the Lustre file system [MB/s/TB].
    type: enum
    enum: [125, 250, 500, 1000]
    default: 125
    required: ${create_lustre}
    visible: 
      and: 
        - create_cluster
        - ${create_lustre}
  install_lustre_client:
    type: boolean
    title: Install Lustre Client Helm Chart
    description: Install the Lustre client Helm chart to install the Lustre client on the worker nodes. 
    visible: 
      and: 
        - create_cluster
        - ${create_lustre}
  lustre_client_helm_chart_version:
    title: Lustre client helm chart version
    type: string
    default: "0.1.1"
    visible: false
  create_lustre_pv:
    type: boolean
    title: Create Lustre Persistent Volume
    description: Create a Lustre persistent volume for the Lustre file system.
    default: true
    visible:
      and:
        - create_cluster
        - create_lustre
        - install_lustre_client

  # Monitoring
  install_monitoring:
    type: boolean
    title: Install Monitoring Stack
    description: Install the Prometheus stack with Grafana, NVIDIA DCGM Exporter, Node Problem Detector, and AMD device metrics exporter.
    default: true
    visible: create_cluster
  monitoring_advanced_options:  
    title: Advanced options
    type: boolean
    default: false
    required: false
    visible: create_cluster
  monitoring_namespace:
    title: Monitoring namespace
    description: The Kubernetes namespace where to deploy resources associated with the cluster monitoring.
    default: "monitoring"
    type: string
    pattern: "^[a-z]([-a-z0-9]*[a-z0-9])?$"
    required: true
    visible: 
      and:
        - create_cluster
        - install_monitoring
        - monitoring_advanced_options
  install_node_problem_detector_kube_prometheus_stack:
    type: boolean
    title: Install Node Problem Detector & Kube Prometheus Stack
    description: Install Node Problem Detector with the Kubernetes Prometheus stack to run GPU & RDMA health checks and use automated alerting in Grafana.
    default: true
    visible:
      and:
        - create_cluster
        - install_monitoring
        - monitoring_advanced_options
  install_nvidia_dcgm_exporter:
    title: DCGM Exporter
    description: Install NVIDIA DCGM Exporter
    type: boolean
    required: true
    default: ${install_monitoring}
    visible:
      and:
        - create_cluster
        - install_monitoring
        - monitoring_advanced_options
  dcgm_exporter_chart_version:
    title: DCGM Exporter chart version
    type: string
    required: true
    default: "4.0.4"
    visible: false
      # and:
      # - monitoring_advanced_options
      # - install_nvidia_dcgm_exporter
  install_amd_device_metrics_exporter:
    title: Install AMD Device Exporter
    type: boolean
    required: true
    default: ${install_monitoring}
    visible:
      and:
        - create_cluster
        - install_monitoring
        - monitoring_advanced_options
  amd_device_metrics_exporter_chart_version:
    title: AMD Device Metrics Exporter chart version
    type: string
    required: true
    default: "v1.2.1"
    visible: false
      # and:
      # - monitoring_advanced_options
      # - install_amd_device_metrics_exporter      
  node_problem_detector_chart_version:
    title: Node Problem Detector chart version
    type: string
    required: true
    default: "2.3.18"
    visible: false
      # and:
      # - monitoring_advanced_options
      # - install_node_problem_detector 
  prometheus_stack_chart_version:
    title: Prometheus stack chart version
    type: string
    required: true
    default: "69.8.2"
    visible: false
      # and:
      # - monitoring_advanced_options
      # - install_amd_device_metrics_exporter
  nginx_chart_version:
    title: Nginx stack chart version
    type: string
    required: true
    default: "4.13.0"
    visible: false
      # and:
      # - monitoring_advanced_options
      # - install_amd_device_metrics_exporter
  install_grafana:
    title: Grafana
    description: Install Grafana
    type: boolean
    required: true
    default: ${install_monitoring}
    visible:
      and:
        - create_cluster
        - install_monitoring
        - monitoring_advanced_options
        - install_node_problem_detector_kube_prometheus_stack
  install_grafana_dashboards:
    title: Grafana dashboards
    description: Install Grafana dashboards
    type: boolean
    required: true
    default: ${install_monitoring}
    visible:
      and:
        - create_cluster
        - install_monitoring
        - monitoring_advanced_options
        - install_node_problem_detector_kube_prometheus_stack
        - install_grafana
  use_lets_encrypt_prod_endpoint:
    title: Use Let's Encrypt production endpoint
    description:  Use Let's Encrypt production endpoint instead of staging.
    type: boolean
    default: true
    required: false
    visible:
      and:
        - create_cluster
        - install_monitoring
        - monitoring_advanced_options
        - install_node_problem_detector_kube_prometheus_stack
        - install_grafana
        - create_public_subnets
  setup_alerting:
    title: Enable Grafana Alerting
    description: Configure Grafana to send notifications to an OCI Notification Topic
    type: boolean
    required: true
    default: ${install_monitoring}
    visible:
      and:
        - create_cluster
        - install_monitoring
        - monitoring_advanced_options
        - install_node_problem_detector_kube_prometheus_stack
        - install_grafana
  avoid_waiting_for_delete_target:
    type: boolean
    title: Accelerate Oracle Notifications Service (ONS) topic deletion on stack destroy
    description: Terminate the topic asynchronously. Don't wait for 15 minutes until the topic is deleted. Supported only via Resource Manager.
    default: true
    visible: 
      and:
        - create_cluster
        - install_monitoring
        - install_node_problem_detector_kube_prometheus_stack
        - setup_alerting
  deploy_to_oke_from_orm:
      title: Securely deploy the monitoring stack via ORM Private Endpoint.
      description: It's <strong>necessary to enable</strong> this option for <strong>clusters without a public endpoint</strong>. More details about <a href='https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Tasks/private-endpoints.htm'>private endpoints</a>.
      visible:
        and:
          - create_cluster
          - or:
            - orm_create_mode
            - install_monitoring
          - not:
            - create_bastion
            - create_operator 
      type: boolean
      required: true
      default: true

  # OKE Cluster Setup
  create_cluster:
    title: Create a Kubernetes cluster
    type: boolean
    default: true
    visible: true
  cluster_name:
    type: string
    title: Cluster name prefix
    description: The Container Engine for Kubernetes cluster name.
    required: true
    visible: create_cluster
  kubernetes_version:
    type: oci:kubernetes:versions:id
    title: Kubernetes version
    description: The Kubernetes version for the created OKE cluster and managed nodes.
    required: true
    dependsOn:
      compartmentId: ${compartment_ocid}
      clusterOptionId: "all"
    visible: create_cluster
  control_plane_allowed_cidrs:
    title: Kubernetes endpoint allowed CIDRs
    description: List of CIDR ranges for allowed Kubernetes endpoint communication.
    required: false
    type: array
    items:
      type: string
      pattern: "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:[0-2]?[0-9])|(?:3[0-2])$"
    unique_items: true
    minItems: 0
    visible: create_cluster
  cni_type:
    title: CNI to use for pod networking
    description: CNI plugin to be used for pod communication on worker nodes in clusters
    required: true
    type: enum
    enum:
    - VCN-Native Pod Networking
    - Flannel
    default: VCN-Native Pod Networking
    visible: create_cluster
  control_plane_is_public:
    title: Create the Kubernetes control plane endpoint in a public subnet and assign it a public IP address
    type: boolean
    default: true
    visible: create_cluster
  max_pods_per_node:
    title: Maximum number of pods per node
    description: The default maximum number of pods to deploy per node when unspecified on a pool
    type: number
    visible: false
  preferred_kubernetes_services:
    type: enum
    enum:
    - internal
    - public
    default: public
    title: Preferred Load Balancer kind
    description: The kind of load balancers which should be provisioned by default for the services of type Load Balancer.
    required: true
    visible: create_cluster
  setup_credential_provider_for_ocir:
    title: Setup OKE credential-provider for OCIR
    description: Allow OKE worker nodes to authenticate with OCIR using instance-principal. If "Create policies" box is not checked, make sure to create policy to allow worker nodes to read repos in compartment.
    type: boolean
    default: false
    visible: create_cluster

# OKE Cluster Setup - Advanced Options
  override_hostnames:
    title: Use hostnames instead of IP addresses as OKE worker node names
    type: boolean
    default: false
    visible: false  
  disable_gpu_device_plugin:
    title: Disable OKE GPU device plugin
    type: boolean
    description: Disable Nvidia GPU Device Plugin that is deployed by OKE. This is required if you want to use the GPU Operator to deploy the GPU device plugin.
    default: false
    visible: create_cluster

  # Workers - System pool
  worker_ops_ad:
    title: Availability domain
    type: oci:identity:availabilitydomain:name
    required: true
    dependsOn:
      compartmentId: ${compartment_ocid}
    visible: create_cluster
  worker_ops_pool_size:
    title: Number of system worker nodes
    type: number
    required: true
    visible: create_cluster
  worker_ops_shape:
    title: Shape
    type: oci:core:instanceshape:name
    pattern: "^(VM|BM)\\.Standard.*$"
    required: true
    dependsOn:
      compartmentId: ${compartment_ocid}
    visible: create_cluster
  worker_ops_ocpus:
    title: OCPUs
    type: number
    required: true
    visible:
      and:
        - create_cluster
        - or:
          - eq: [worker_ops_shape, "VM.Standard3.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.A1.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.A2.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.E4.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.E5.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.E6.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.x86.Generic"]
          - eq: [worker_ops_shape, "VM.Standard.AMD.Generic"]
          - eq: [worker_ops_shape, "VM.Standard.Ampere.Generic"]
          - eq: [worker_ops_shape, "VM.Standard.Intel.Generic"]
  worker_ops_memory:
    title: Memory (GB)
    type: number
    required: true
    visible:
      and: 
        - create_cluster
        - or:
          - eq: [worker_ops_shape, "VM.Standard3.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.A1.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.A2.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.E4.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.E5.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.E6.Flex"]
          - eq: [worker_ops_shape, "VM.Standard.x86.Generic"]
          - eq: [worker_ops_shape, "VM.Standard.AMD.Generic"]
          - eq: [worker_ops_shape, "VM.Standard.Ampere.Generic"]
          - eq: [worker_ops_shape, "VM.Standard.Intel.Generic"]
  worker_ops_boot_volume_size:
    title: Boot volume size (GB)
    type: number      
    visible: create_cluster
  worker_ops_image_type:
    title: Image type
    default: Custom
    description: Whether to use an OKE, Platform, Custom, or imported image for worker nodes.
    type: enum
    enum: [Custom]
    required: true
    visible: false
  worker_ops_image_use_uri:
    title: Import custom image from URI
    type: boolean
    visible: create_cluster
  worker_ops_image_custom_uri:
    title: Image URI
    type: string
    visible:
      and:
        - create_cluster
        - eq: [worker_ops_image_type, Custom]
        - ${worker_ops_image_use_uri}
  worker_ops_image_compartment:
    title: "Operational worker pool image compartment"
    type: oci:identity:compartment:id
    required: true
    default: ${compartment_ocid}
    visible:
      and:
        - create_cluster
        - eq: [worker_ops_image_type, Custom]
        - not: [worker_ops_image_use_uri]
  worker_ops_image_custom_id:
    title: Image
    type: oci:core:image:id
    required: true
    dependsOn:
      compartmentId: ${worker_ops_image_compartment}
    visible:
      and:
        - create_cluster
        - eq: [worker_ops_image_type, Custom]
        - not: [worker_ops_image_use_uri]

  # Workers - CPU pool
  worker_cpu_enabled:
    title: Create CPU pool
    type: boolean
    description: Create an OKE-managed general purpose node pool
    default: false
    visible: create_cluster
  worker_cpu_ad:
    title: Availability domain
    type: oci:identity:availabilitydomain:name
    required: true
    visible: 
      and:
        - create_cluster
        - ${worker_cpu_enabled}
    default: worker_ops_ad
    dependsOn:
      compartmentId: ${compartment_ocid}  
  worker_cpu_pool_size:
    title: Number of worker nodes
    type: number
    visible: 
      and:
        - create_cluster
        - ${worker_cpu_enabled}
  worker_cpu_shape:
    title: Shape
    type: oci:core:instanceshape:name
    pattern: "^(VM|BM)\\.(Standard|Dense).*$"
    default: "VM.Standard.E5.Flex"
    required: true
    visible: 
      and:
        - create_cluster
        - ${worker_cpu_enabled}
    dependsOn:
      compartmentId: ${compartment_ocid}
  worker_cpu_ocpus:
    title: OCPUs
    type: number
    required: true
    visible:
      and:
        - create_cluster
        - ${worker_cpu_enabled}
        - or:
          - eq: [worker_cpu_shape, "VM.Standard3.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.A1.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.A2.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.E4.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.E5.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.E6.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.x86.Generic"]
          - eq: [worker_cpu_shape, "VM.Standard.AMD.Generic"]
          - eq: [worker_cpu_shape, "VM.Standard.Ampere.Generic"]
          - eq: [worker_cpu_shape, "VM.Standard.Intel.Generic"]
  worker_cpu_memory:
    title: Memory (GB)
    type: number
    required: true
    visible:
      and:
        - create_cluster
        - ${worker_cpu_enabled}
        - or:
          - eq: [worker_cpu_shape, "VM.Standard3.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.A1.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.A2.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.E4.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.E5.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.E6.Flex"]
          - eq: [worker_cpu_shape, "VM.Standard.x86.Generic"]
          - eq: [worker_cpu_shape, "VM.Standard.AMD.Generic"]
          - eq: [worker_cpu_shape, "VM.Standard.Ampere.Generic"]
          - eq: [worker_cpu_shape, "VM.Standard.Intel.Generic"]
  worker_cpu_boot_volume_size:
    title: Boot volume size (GB)
    type: number
    visible: 
      and: 
        - create_cluster
        - ${worker_cpu_enabled}
  worker_cpu_image_type:
    title: Image type
    default: Custom
    description: Whether to use an OKE, Platform, Custom, or imported image for worker nodes.
    type: enum
    enum: [Custom]
    required: true
    visible: false
  worker_cpu_image_use_uri:
    title: Import custom image from URI
    type: boolean
    visible: 
      and: 
        - create_cluster
        - ${worker_cpu_enabled}
  worker_cpu_image_custom_uri:
    title: Image URI
    type: string
    visible:
      and:
        - create_cluster
        - eq: [worker_cpu_image_type, Custom]
        - ${worker_cpu_enabled}
        - ${worker_cpu_image_use_uri}
  worker_cpu_image_compartment:
    title: "CPU worker pool image compartment"
    type: oci:identity:compartment:id
    required: true
    default: ${compartment_ocid}
    visible:
      and:
        - create_cluster
        - eq: [worker_cpu_image_type, Custom]
        - ${worker_cpu_enabled}
        - not: [worker_cpu_image_use_uri]
  worker_cpu_image_custom_id:
    title: Image
    type: oci:core:image:id
    required: true
    dependsOn:
      compartmentId: ${worker_cpu_image_compartment}
    visible:
      and:
        - create_cluster
        - eq: [worker_cpu_image_type, Custom]
        - ${worker_cpu_enabled}
        - not: [worker_cpu_image_use_uri]
  worker_cpu_image_os:
    title: Operating system
    type: enum
    default: "Ubuntu"
    enum: ["Ubuntu"]
    required: true
    visible:
      and:
        - create_cluster
        - ${worker_cpu_enabled}
        - or:
          - eq: [worker_cpu_image_type, OKE]
          - eq: [worker_cpu_image_type, Platform]
  worker_cpu_image_os_version:
    title: Operating system version
    type: enum
    default: "22.04"
    enum: ["22.04"]
    required: true
    visible:
      and:
        - create_cluster
        - ${worker_cpu_enabled}
        - or:
          - eq: [worker_cpu_image_type, OKE]
          - eq: [worker_cpu_image_type, Platform]
  worker_cpu_image_platform_id:
    title: Image
    type: oci:core:image:id
    required: true
    dependsOn:
      compartmentId: ${compartment_ocid}
      operatingSystem: ${worker_cpu_image_os}
      operatingSystemVersion: ${worker_cpu_image_os_version}
    visible:
      and:
        - create_cluster
        - ${worker_cpu_enabled}
        - eq: [worker_cpu_image_type, Platform]

  # Workers - GPU node-pool
  worker_gpu_enabled:
    title: Create GPU pool
    type: boolean
    description: Create an OKE-managed node pool with GPU resources.
    visible: create_cluster
  worker_gpu_ad:
    title: Availability domain
    type: oci:identity:availabilitydomain:name
    required: true
    default: worker_ops_ad
    visible: 
      and:
        - create_cluster
        - ${worker_gpu_enabled}
    dependsOn:
      compartmentId: ${compartment_ocid}
  worker_gpu_pool_size:
    title: Number of GPU worker nodes
    type: number
    visible: 
      and:
        - create_cluster
        - ${worker_gpu_enabled}
  worker_gpu_shape:
    title: Shape
    type: oci:core:instanceshape:name
    required: true
    pattern: "^(VM|BM)\\.GPU.*$"
    visible: 
      and:
        - create_cluster
        - ${worker_gpu_enabled}
    dependsOn:
      compartmentId: ${compartment_ocid}
  worker_gpu_boot_volume_size:
    title: Boot volume size (GB)
    type: number
    visible: 
      and:
        - create_cluster
        - ${worker_gpu_enabled}
  worker_gpu_image_type:
    title: Image type
    description: Whether to use an OKE, Platform, Custom, or imported image for worker nodes.
    type: enum
    default: Custom
    enum: [Custom]
    required: true
    visible: false
  worker_gpu_image_use_uri:
    title: Import custom image from URI
    type: boolean
    visible: 
      and:
        - create_cluster
        - ${worker_gpu_enabled}
  worker_gpu_image_custom_uri:
    title: Image URI
    type: string
    visible:
      and:
        - create_cluster
        - eq: [worker_gpu_image_type, Custom]
        - ${worker_gpu_enabled}
        - ${worker_gpu_image_use_uri}
  worker_gpu_image_compartment:
    title: "GPU worker pool image compartment"
    type: oci:identity:compartment:id
    required: true
    default: ${compartment_ocid}
    visible:
      and:
        - create_cluster
        - eq: [worker_gpu_image_type, Custom]
        - ${worker_gpu_enabled}
        - not: [worker_gpu_image_use_uri]
  worker_gpu_image_custom_id:
    title: Image
    type: oci:core:image:id
    required: true
    dependsOn:
      compartmentId: ${worker_gpu_image_compartment}
    visible:
      and:
        - create_cluster
        - eq: [worker_gpu_image_type, Custom]
        - ${worker_gpu_enabled}
        - not: [worker_gpu_image_use_uri]
  worker_gpu_image_os:
    title: Operating system
    type: enum
    default: "Ubuntu"
    enum: ["Ubuntu"]
    required: true
    visible:
      and:
        - create_cluster
        - ${worker_gpu_enabled}
        - or:
          - eq: [worker_gpu_image_type, OKE]
          - eq: [worker_gpu_image_type, Platform]
  worker_gpu_image_os_version:
    title: Operating system version
    type: enum
    default: "22.04"
    enum: ["22.04"]
    required: true
    visible:
      and:
        - create_cluster
        - ${worker_gpu_enabled}
        - or:
          - eq: [worker_gpu_image_type, OKE]
          - eq: [worker_gpu_image_type, Platform]
  worker_gpu_image_platform_id:
    title: Image
    type: oci:core:image:id
    required: true
    dependsOn:
      compartmentId: ${compartment_ocid}
      operatingSystem: ${worker_gpu_image_os}
      operatingSystemVersion: ${worker_gpu_image_os_version}
      shape: ${worker_shape_name}
    visible:
      and:
        - create_cluster
        - ${worker_gpu_enabled}
        - eq: [worker_gpu_image_type, Platform]

  # Workers - GPU Cluster-network
  worker_rdma_enabled:
    title: Create GPU + RDMA pool
    type: boolean
    description: Create a worker pool with Cluster Network placement for RDMA networking
    visible: create_cluster
  worker_rdma_ad:
    title: Availability domain
    type: oci:identity:availabilitydomain:name
    required: true
    default: worker_ops_ad
    visible: 
      and:
        - create_cluster
        - ${worker_rdma_enabled}
    dependsOn:
      compartmentId: ${compartment_ocid}
  worker_rdma_pool_size:
    title: Number of RDMA worker nodes
    type: number
    required: true
    visible: 
      and:
        - create_cluster
        - ${worker_rdma_enabled}
  worker_rdma_shape:
    title: Shape
    type: oci:core:instanceshape:name
    pattern: "^BM\\.(HPC|GPU|Optimized).*$"
    required: true
    visible: 
      and:
        - create_cluster
        - ${worker_rdma_enabled}
    dependsOn:
      compartmentId: ${compartment_ocid}
  worker_rdma_boot_volume_size:
    title: Boot volume size (GB)
    type: number
    visible: 
      and:
        - create_cluster
        - ${worker_rdma_enabled}
  worker_rdma_boot_volume_vpus_per_gb:
    title: Boot volume performance (VPUs/GB)
    type: number
    visible: false
  worker_rdma_image_type:
    title: Image type
    description: Whether to use an OKE, Platform, Custom, or imported image for GPU worker nodes.
    type: enum
    default: Custom
    enum: [Custom]
    required: true
    visible: false
  worker_rdma_image_os:
    title: Operating system
    type: enum
    default: "Ubuntu"
    enum: ["Ubuntu"]
    required: true
    visible:
      and:
        - create_cluster
        - ${worker_rdma_enabled}
        - or:
          - eq: [worker_rdma_image_type, OKE]
          - eq: [worker_rdma_image_type, Platform]
  worker_rdma_image_os_version:
    title: Operating system version
    type: enum
    default: "22.04"
    enum: ["22.04"]
    required: true
    visible:
      and:
        - create_cluster
        - ${worker_rdma_enabled}
        - or:
          - eq: [worker_rdma_image_type, OKE]
          - eq: [worker_rdma_image_type, Platform]
  worker_rdma_image_platform_id:
    title: Image
    type: ocid
    required: true
    dependsOn:
      compartmentId: ${compartment_ocid}
      operatingSystem: ${worker_image_os}
      operatingSystemVersion: ${worker_image_os_version}
      shape: ${worker_shape_name}
    visible:
      and:
        - create_cluster
        - ${worker_rdma_enabled}
        - eq: [worker_rdma_image_type, Platform]
  worker_rdma_image_use_uri:
    title: Import custom image from URI
    type: boolean
    visible:
      and:
        - create_cluster
        - ${worker_rdma_enabled}
  worker_rdma_image_custom_uri:
    title: Image URI
    type: string
    visible:
      and:
        - create_cluster
        - eq: [worker_rdma_image_type, Custom]
        - ${worker_rdma_enabled}
        - ${worker_rdma_image_use_uri}
  worker_rdma_image_compartment:
    title: "GPU + RDMA worker pool image compartment"
    type: oci:identity:compartment:id
    required: true
    default: ${compartment_ocid}
    visible:
      and:
        - create_cluster
        - eq: [worker_rdma_image_type, Custom]
        - ${worker_rdma_enabled}
        - not: [worker_rdma_image_use_uri]
  worker_rdma_image_custom_id:
    title: Image
    description: Only Ubuntu custom images are supported with GPU & RDMA worker pools. Oracle Linux images are not supported.
    type: oci:core:image:id
    required: true
    dependsOn:
      compartmentId: ${worker_rdma_image_compartment}
    visible:
      and:
        - create_cluster
        - eq: [worker_rdma_image_type, Custom]
        - ${worker_rdma_enabled}
        - not: [worker_rdma_image_use_uri]

  # SSH access to the nodes
  ssh_public_key:
    title: SSH public key
    description: The SSH public key to access the bastion, operator, and worker nodes.
    type: oci:core:ssh:publickey
    pattern: "((^(ssh-rsa AAAAB3NzaC1yc2|ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNT|ecdsa-sha2-nistp384 AAAAE2VjZHNhLXNoYTItbmlzdHAzODQAAAAIbmlzdHAzOD|ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1Mj|ssh-ed25519 AAAAC3NzaC1lZDI1NTE5|ssh-dss AAAAB3NzaC1kc3)[0-9A-Za-z+\/]+[=]{0,3})( [^,]*)?)(,((ssh-rsa AAAAB3NzaC1yc2|ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNT|ecdsa-sha2-nistp384 AAAAE2VjZHNhLXNoYTItbmlzdHAzODQAAAAIbmlzdHAzOD|ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1Mj|ssh-ed25519 AAAAC3NzaC1lZDI1NTE5|ssh-dss AAAAB3NzaC1kc3)[0-9A-Za-z+\/]+[=]{0,3})( [^,]*)?)*$"
    required: false
    visible:
      or:
        - create_bastion
        - create_cluster
        - create_operator

outputGroups:
  - title: Terraform
    outputs:
      - state_id
      - stack_version

  - title: Network
    outputs:
      - vcn_id
      - vcn_name
      - ig_route_table_id
      - nat_route_table_id

  - title: Bastion
    outputs:
      - bastion_id
      - bastion_subnet_id
      - bastion_subnet_cidr
      - bastion_nsg_id
      - bastion_public_ip
      - bastion_ssh_command
      - bastion_ssh_secret_id

  - title: Operator
    outputs:
      - operator_id
      - operator_subnet_id
      - operator_subnet_cidr
      - operator_nsg_id
      - operator_private_ip
      - operator_ssh_command

#  - title: File Storage Service (FSS)
#    outputs:
#      - fss_ad
#      - fss_subnet_id
#      - fss_nsg_id
#      - fss_volume_name
#      - fss_filesystem_id
#      - fss_mount_target_id
#      - fss_mount_target_ip
#      - fss_export_set_id

  - title: Cluster
    outputs:
      - cluster_name
      - cluster_id
      - cluster_ca_cert
      - cluster_public_endpoint
      - cluster_private_endpoint
      - control_plane_subnet_id
      - control_plane_subnet_cidr
      - control_plane_nsg_id
      - access_k8s_public_endpoint
      - access_k8s_private_endpoint

  - title: Load balancers
    outputs:
      - int_lb_subnet_id
      - int_lb_subnet_cidr
      - int_lb_nsg_id
      - pub_lb_subnet_id
      - pub_lb_subnet_cidr
      - pub_lb_nsg_id

  - title: Workers
    outputs:
      - worker_subnet_id
      - worker_subnet_cidr
      - worker_nsg_id
      - worker_ops_pool_id
      - worker_ops_image_id
      - worker_cpu_pool_id
      - worker_cpu_image_id
      - worker_gpu_pool_id
      - worker_gpu_image_id
      - worker_rdma_pool_id
      - worker_rdma_image_id

  - title: Monitoring
    outputs:
      - grafana_url
      - grafana_admin_password
      - grafana_port_forward
      - grafana_fetch_endpoint_command
      - prom_server_port_forward
      - prom_pushgateway_port_forward
      - prom_pushgateway_port_forward
      - prometheus_pushgateway_version
      - prometheus_adapter_version
      - metrics_server_version
      - dcgm_exporter_version
      
outputs:
  # Terraform
  state_id:
    title: State ID
    type: copyableString
  stack_version:
    title: Stack Version
    type: copyableString

  # Network
  vcn_id:
    title: VCN
    type: ocid
  vcn_name:
    title: VCN name
    type: string
  ig_route_table_id:
    title: Internet gateway route table
    type: ocid
  nat_route_table_id:
    title: NAT gateway route table
    type: ocid
  subnet_cidrs:
    visible: false
  subnet_ids:
    visible: false
  network_security_rules:
    visible: false

  # Bastion
  bastion_id:
    title: Instance
    type: ocid
  bastion_subnet_id:
    title: Subnet
    type: ocid
  bastion_subnet_cidr:
    title: Subnet CIDR
    type: string
  bastion_nsg_id:
    title: Network security group
    type: ocid
  bastion_public_ip:
    title: Address
    type: copyableString
  bastion_ssh_command:
    title: SSH command
    type: copyableString

  # Operator
  operator_id:
    title: Instance
  operator_subnet_id:
    title: Subnet
    type: ocid
  operator_subnet_cidr:
    title: Subnet CIDR
    type: string
  operator_nsg_id:
    title: Network security group
    type: ocid
  operator_private_ip:
    title: Address
    type: copyableString
  operator_ssh_command:
    title: SSH command
    type: copyableString

  # Cluster
  cluster_id:
    title: Cluster ID
    type: ocid
  cluster_name:
    title: Cluster name
    type: string
  cluster_public_endpoint:
    title: Public endpoint
    type: copyableString
  cluster_private_endpoint:
    title: Private endpoint
    type: copyableString
  control_plane_subnet_id:
    title: Subnet
    type: ocid
  control_plane_subnet_cidr:
    title: Subnet CIDR
    type: string
  control_plane_nsg_id:
    title: Network security group
    type: ocid
  access_k8s_public_endpoint:
    title: OCI CLI command to access the kubeconfig for your cluster via the public endpoint
    type: copyableString
  access_k8s_private_endpoint:
    title: OCI CLI command to access the kubeconfig for your cluster via the private endpoint
    type: copyableString    

  # Load balancers
  int_lb_subnet_id:
    title: Internal subnet
    type: ocid
  int_lb_subnet_cidr:
    title: Internal CIDR
    type: string
  int_lb_nsg_id:
    title: Internal network security group
    type: ocid
  pub_lb_subnet_id:
    title: Public subnet
    type: ocid
  pub_lb_subnet_cidr:
    title: Public CIDR
    type: string
  pub_lb_nsg_id:
    title: Public network security group
    type: ocid

  # Workers
  worker_subnet_id:
    title: Subnet
    type: ocid
    visible: create_cluster
  worker_subnet_cidr:
    title: Subnet CIDR
    type: string
    visible: create_cluster
  worker_nsg_id:
    title: Network security group
    type: ocid
    visible: create_cluster
  worker_ops_pool_id:
  # Workers - System pool
    title: System pool
    type: ocid
    visible: create_cluster
  worker_cpu_pool_id:
    title: CPU pool
    type: ocid
    visible: 
      and:
        - create_cluster
        - ${worker_cpu_enabled}
  worker_gpu_pool_id:
    title: GPU pool
    type: ocid
    visible: 
      and:
        - create_cluster
        - worker_gpu_enabled
  worker_rdma_pool_id:
    title: RDMA pool
    type: ocid
    visible: 
      and: 
        - create_cluster
        - ${worker_rdma_enabled}
  
  # Pods
  pod_subnet_id:
    title: Subnet
    type: ocid
    visible: false
  pod_subnet_cidr:
    title: Subnet CIDR
    type: string
    visible: false
  pod_nsg_id:
    title: Network security group
    type: ocid
    visible: false

  # Monitoring
  grafana_url:
      title: Grafana URL
      type: string
      visible:
        and:
          - create_cluster
          - install_node_problem_detector_kube_prometheus_stack
  grafana_fetch_endpoint_command:
      title: Command to get the Grafana endpoint
      type: string
      visible:
        and:
          - create_cluster
          - install_node_problem_detector_kube_prometheus_stack
  grafana_admin_password:
    title: Grafana admin password
    type: copyableString
    visible:
      and:
        - create_cluster
        - install_node_problem_detector_kube_prometheus_stack
        - install_grafana
  grafana_port_forward:
     title: Grafana port forward command
     visible:
       and:
        - create_cluster
        - install_node_problem_detector_kube_prometheus_stack
        - install_grafana
  prom_server_port_forward:
      title: Prometheus server port forward command
      type: string
      visible:
        and:
          - create_cluster
          - install_node_problem_detector_kube_prometheus_stack
  prometheus_stack_chart_version:
      title: Prometheus stack chart version
      type: string
      visible: false
  